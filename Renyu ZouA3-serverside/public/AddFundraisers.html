<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../styles.css">
    <title>Edit/Add Fundraiser</title>
</head>
<body>

    <nav>
        <a href="/admin">Home page</a>
    </nav>

    <section class="content" style="text-align: center; padding-top: 20px;">
        <h1 class="title" id="page-title">Add Fundraiser</h1>
        
        <form id="fundraiser-form" style="max-width: 600px; margin: 0 auto;">
            <div class="form-group">
                <label for="caption">Caption:</label>
                <input type="text" id="caption" name="caption" required>
                <div id="caption-error" style="color: red; display: none;">Caption is required.</div>
            </div>

            <div class="form-group">
                <label for="organizer">Organizer:</label>
                <input type="text" id="organizer" name="organizer" required>
                <div id="organizer-error" style="color: red; display: none;">Organizer is required.</div>
            </div>

            <div class="form-group">
                <label for="target-funding">Target Funding:</label>
                <input type="number" id="target-funding" name="target-funding" min="1" required>
                <div id="target-funding-error" style="color: red; display: none;">Target Funding must be greater than 0.</div>
            </div>

            <div class="form-group">
                <label for="current-funding">Current Funding:</label>
                <span id="current-funding-display" class="current-funding"></span>
                <input type="number" id="current-funding" name="current-funding" min="0" required>
                <div id="current-funding-error" style="color: red; display: none;">Current Funding cannot be greater than Target Funding.</div>
            </div>

            <div class="form-group">
                <label for="city">City:</label>
                <input type="text" id="city" name="city" required>
                <div id="city-error" style="color: red; display: none;">City is required.</div>
            </div>

            <div class="form-group">
                <label for="category">Category:</label>
                <select id="category" name="category" required>
                    <option value="">Select Category</option>
                    <!-- 动态填充类别选项 -->
                </select>
                <div id="category-error" style="color: red; display: none;">Please select a category.</div>
            </div>

            <button id="save-button" type="button" style="font-size: 16px; font-weight: bold; padding: 10px 15px; margin-top: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Save
            </button>
        </form>
    </section>

    <script>
       // Load the logic for the category options
        fetch('http://localhost:3000/api/categories')
        .then(response => response.json())
        .then(categories => {
            const categorySelect = document.getElementById('category');
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.CATEGORY_ID; // Select the correct ID
                option.textContent = category.NAME; // Display the category name
                categorySelect.appendChild(option);
            });
        })
        .catch(error => console.error('Error fetching categories:', error));

        // Determines the logic of editing mode
        const urlParams = new URLSearchParams(window.location.search);
        const fundraiserId = urlParams.get('id');
        if (fundraiserId) {
            // Edit mode to load existing fundraiser data from the API
            fetch(`http://localhost:3000/api/fundraiser/${fundraiserId}`)
                .then(response => response.json())
                .then(fundraiser => {
                    document.getElementById('page-title').textContent = 'Edit Fundraiser';
                    document.getElementById('caption').value = fundraiser.CAPTION;
                    document.getElementById('organizer').value = fundraiser.ORGANIZER;
                    document.getElementById('target-funding').value = fundraiser.TARGET_FUNDING;
                    document.getElementById('current-funding-display').textContent = `$${fundraiser.CURRENT_FUNDING.toLocaleString()}`;
                    document.getElementById('current-funding').value = fundraiser.CURRENT_FUNDING; // Enter current fundraising when editing
                    document.getElementById('city').value = fundraiser.CITY;
                    document.getElementById('category').value = fundraiser.CATEGORY_ID;
                    document.getElementById('current-funding').style.display='none'
                })
                .catch(error => console.error('Error fetching fundraiser details:', error));
        } else {
            // Add mode to clear the current fundraising field
            document.getElementById('current-funding-display').textContent = '';
        }

        document.getElementById('save-button').addEventListener('click', function () {
            // Clear the previous error message
            document.getElementById('caption-error').style.display = 'none';
            document.getElementById('organizer-error').style.display = 'none';
            document.getElementById('target-funding-error').style.display = 'none';
            document.getElementById('current-funding-error').style.display = 'none';
            document.getElementById('city-error').style.display = 'none';
            document.getElementById('category-error').style.display = 'none';

            // Form validation
            const caption = document.getElementById('caption').value.trim();
            const organizer = document.getElementById('organizer').value.trim();
            const targetFunding = parseFloat(document.getElementById('target-funding').value);
            const currentFunding = parseFloat(document.getElementById('current-funding').value);
            const city = document.getElementById('city').value.trim();
            const category = document.getElementById('category').value;

            let valid = true;

            if (!caption) {
                document.getElementById('caption-error').style.display = 'block';
                valid = false;
            }
            if (!organizer) {
                document.getElementById('organizer-error').style.display = 'block';
                valid = false;
            }
            if (targetFunding <= 0) {
                document.getElementById('target-funding-error').style.display = 'block';
                valid = false;
            }
            if (currentFunding > targetFunding) {
                document.getElementById('current-funding-error').style.display = 'block';
                valid = false;
            }
            if (!city) {
                document.getElementById('city-error').style.display = 'block';
                valid = false;
            }
            if (!category) {
                document.getElementById('category-error').style.display = 'block';
                valid = false;
            }

            if (!valid) {
                return; // If the authentication fails, stop the execution
            }

            const formData = {
                id: fundraiserId,
                caption: caption,
                organizer: organizer,
                targetFunding: targetFunding,
                currentFunding: currentFunding,
                city: city,
                category: category
            };

            // Determine whether to add or modify
            const method = fundraiserId ? 'PUT' : 'POST';
            const url = fundraiserId ? `http://localhost:3000/api/edit/fundraiser` : `http://localhost:3000/api/add/fundraiser`;

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (response.ok) {
                    alert('Success!');
                    window.location.href = '/admin'; // Jump to the fundraiser list
                } else {
                    throw new Error('Error saving fundraiser');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the fundraiser.');
            });
        });
    </script>

</body>
</html>
